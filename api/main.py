import requests
import json
import os

# ???? ak ?sk ?????????????????????????????????????????????????????
# ???? ak ? sk ????????????????????????????????????HUAWEICLOUD_SDK_AK?HUAWEICLOUD_SDK_SK?
# ???terminal?????????????notebook?????notebook??? %env ??????

ak = os.getenv("THUVY3U04HKLMWFL8ZTH")  # ??ak,?? ak = "2HADXXXXXXXXXXXX1BGD"
sk = os.getenv("nM7cIGJoqcU9MboDqjATjOCuBfEiBl0ovBnQBa6W")  # ??sk,?? sk = "jyo2XXXXXXXXXXXXXXXXXXXXXXXXXXXXXpVCj1T2"
ak = "THUVY3U04HKLMWFL8ZTH"
sk = "nM7cIGJoqcU9MboDqjATjOCuBfEiBl0ovBnQBa6W"

print(ak)
if not ak or not sk:
    raise ValueError("????????")

url = "https://iam.cn-southwest-2.myhuaweicloud.com/v3/auth/tokens"

payload = json.dumps({
    "auth": {
        "identity": {
            "methods": [
                "hw_ak_sk"
            ],
            "hw_ak_sk": {
                "access": {
                    "key": ak
                },
                "secret": {
                    "key": sk
                }
            }
        },
        "scope": {
            "project": {
                "name": "cn-southwest-2"
            }
        }
    }
})
headers = {
    'Content-Type': 'application/json'
}

response = requests.request("POST", url, headers=headers, data=payload)
X_Auth_Token = response.headers["X-Subject-Token"]
print(X_Auth_Token)



import os

proxy  = os.environ.get('http_proxy')
print(proxy)
proxies = {"http": proxy, "https": proxy}
headers = {"Content-Type": "application/json", "X-Auth-Token": X_Auth_Token}

project_id = "43eb9d38a7034c0dabecd2534d72e123"

def get_text(prompt, **args):
    url = "https://pangu.cn-southwest-2.myhuaweicloud.com/v1/infers/7c996ea5-a08d-4480-9b47-29b71df679ce/v1/43eb9d38a7034c0dabecd2534d72e123/deployments/abd45976-f351-4ebc-af2b-20bb4bbebf48/text/completions"  # ????????????????
    body = {"prompt": prompt}
    # , "top_p": 0.8, "n": 2
    # body.update(args)
    resp = requests.request("POST", url, headers=headers, data=json.dumps(body), proxies=proxies)
    return json.loads(resp.text)

prompt = "??????????????????"
text = get_text(prompt, max_tokens=1000, temperature=0.9, n=2)
print(text)


def get_chat(content, **args):
    url = f"https://pangu.cn-southwest-2.myhuaweicloud.com/v1/infers/7c996ea5-a08d-4480-9b47-29b71df679ce/v1/{project_id}/deployments/40051e78-885d-4d22-aa1e-a5de9f870759/chat/completions"  # ????????????????

    body = {"messages": content}
    body.update(args)
    resp = requests.request("POST", url, headers=headers, data=json.dumps(body), proxies=proxies)
    return json.loads(resp.text)

content = [{"content": "????????????????"}]
chat = get_chat(content, max_tokens=1000, temperature=0.9)
print(chat)

# ????
# content = [{"content": "????????????????"}]

# ??????????role????system?
# content = [
#     {
#         "role": "system",
#         "content": "?????????????????????????????????????????????????"
#     },
#     {
#         "role": "user",
#         "content": "????????????????"
#     }
# ]

# ????
content = [
    {"content": "????????????????"},  # ?????
    {"content": "????????????6300??????????????????????11????????????\n????????????????????????????????????????????????????"},  # ?????
    {"content": "??????2????????????"},  # ?????
    {"content": "????????????\n2. ???:?????"},  # ?????
    {"content": "?????????????"}  # ?????
]
chat = get_chat(content, max_tokens=1000, temperature=0.9, presence_penalty=0.8)
print(chat)